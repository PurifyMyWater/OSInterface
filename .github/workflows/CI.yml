# https://cpp-linter.github.io/cpp-linter-action/

name: CI

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on: push

jobs:
    Linter:
        runs-on: ubuntu-latest
        env:
            GH_PAT: ${{ secrets.PMW_CI_PAT }}

        permissions:
            contents: write
            pull-requests: write

        steps:
            -   name: Install dependencies
                run: |
                    sudo apt-get update
                    sudo apt-get install -y clang libstdc++-dev

            -   name: "Checkout repository"
                uses: actions/checkout@v4

            -   name: Configure CMake
                working-directory: ${{ runner.workspace }}
                run: mkdir build && cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS=--coverage -DCMAKE_C_FLAGS=--coverage -S $GITHUB_WORKSPACE -B ./build

            -   name: Linter
                uses: cpp-linter/cpp-linter-action@v2
                id: linter
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    version: 19
                    # ignore: 'CANInterface/|Tests/DoCANCppLibTests/'
                    style: 'file'  # Use .clang-format config file
                    tidy-checks: '' # Use .clang-tidy config file
                    database: '${{ runner.workspace }}/build'
                    step-summary: true
                    tidy-review: true
                    format-review: true
                    lines-changed-only: false # Only Check the lines that have changed
                    files-changed-only: true # Only check the files that have changed
                    # only 'update' a single comment in a pull request thread.
                    thread-comments: ${{ github.event_name == 'pull_request' && 'update' }}

            -   name: Clang Tidy Fail Check
                if: steps.linter.outputs.clang-tidy-checks-failed > 0
                run: exit 1 # To enable or disable this check as an error, run exit 1 / exit 0.

            -   name: Clang Format Fail Check
                if: steps.linter.outputs.clang-format-checks-failed > 0
                run: exit 1 # To enable or disable this check as an error, run exit 1 / exit 0.
